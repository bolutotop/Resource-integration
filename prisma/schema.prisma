generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- Content Models ---

model Video {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  videoUrl    String
  coverUrl    String?
  rating      Float    @default(0.0)
  views       Int      @default(0)
  
  // --- Video Type (Primary Classification) ---
  type        String   @default("电影") // e.g., Movie, Series, Anime
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categories  Category[] // Secondary Classification
  tags        Tag[]      // Tags

  // --- Likes Logic ---
  likesCount  Int      @default(0) // Cache for total likes
  likes       Like[]   // Relation: Likes received by video
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

model Tag {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

model Image {
  id        Int      @id @default(autoincrement())
  filename  String   // File name
  url       String   @unique // Access path
  createdAt DateTime @default(now())
}

// --- User & Interaction Models ---

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String   // Hashed password
  avatar    String?
  role      String   @default("USER") // "USER" or "ADMIN"
  createdAt DateTime @default(now())

  // --- Relations ---
  likes     Like[]     // User's given likes
  history   History[]  // User's browsing history
  favorites Favorite[] // User's favorites
  comments  Comment[]  // <--- 新增：关联用户发表的评论
}

// --- Like Relation (Specific to Videos) ---
model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  videoId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Constraint: One like per user per video
  @@unique([userId, videoId])
}

// --- Generic History (Snapshot Style) ---
model History {
  id         Int      @id @default(autoincrement())
  userId     Int
  
  // Core Reference Data
  targetId   Int      // Resource ID
  targetType String   // "MOVIE", "SOFTWARE", "GAME", "MUSIC"
  
  // Snapshot Data (Fast read without joins)
  title      String
  coverUrl   String?
  routeUrl   String   // e.g., "/video/1"

  visitedAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraint for Upsert logic
  @@unique([userId, targetId, targetType])
  
  // Index for querying: Filter by User, Sort by Time
  @@index([userId, visitedAt])
}

// --- Generic Favorites (Snapshot Style) ---
model Favorite {
  id         Int      @id @default(autoincrement())
  userId     Int
  
  // Core Reference Data
  targetId   Int
  targetType String   // "MOVIE", "SOFTWARE", "GAME", "MUSIC"
  
  // Snapshot Data
  title      String
  coverUrl   String?
  routeUrl   String

  createdAt  DateTime @default(now()) 

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Unique constraint: Prevent duplicate bookmarks
  @@unique([userId, targetId, targetType])
  
  // Index: Filter by User, Sort by Added Time
  @@index([userId, createdAt])
}

// --- 新增：通用评论表 (Generic Comment System) ---
model Comment {
  id         Int      @id @default(autoincrement())
  content    String   // SQLite 中 String 默认即为 Text，无需 @db.Text
  
  userId     Int
  
  // 核心解耦字段 (Polymorphic-like association)
  targetId   Int
  targetType String   // e.g., "MOVIE", "SOFTWARE", "GAME"
  
  // 支持回复 (自关联)
  parentId   Int?     
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 父子评论关联
  parent     Comment?  @relation("ReplyTo", fields: [parentId], references: [id], onDelete: Cascade)
  children   Comment[] @relation("ReplyTo")

  // 索引优化：通常是查询某个资源下的所有评论
  @@index([targetId, targetType]) 
}