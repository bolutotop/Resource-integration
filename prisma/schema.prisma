generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- 内容模型 ---

model Video {
  id          Int      @id @default(autoincrement())
  title       String
  // 注意：SQLite 中 String 默认就是 Text，不支持 @db.Text，直接使用 String 即可
  description String? 
  videoUrl    String   @default("") 
  coverUrl    String?
  type        String   @default("电影")
  rating      Float    @default(0.0)
  views       Int      @default(0)
  
  // --- 新增 & 优化字段 ---
  sourceId    String?  @unique // 外部资源唯一 ID，用于防重
  status      String?          // 连载、完结、预告等
  
year        String?  // 新增：年份 (如 "2026")
  studio      String?  // 新增：制作公司 (如 "J.C.STAFF")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  categories  Category[] 
  tags        Tag[]      
  likesCount  Int      @default(0) 
  likes       Like[]   
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

model Tag {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

// --- 用户与交互模型 ---

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String   
  avatar    String?
  role      String   @default("USER") 
  createdAt DateTime @default(now())

  likes     Like[]   
  history   History[] 
  favorites Favorite[] 
  comments  Comment[]  
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  videoId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
}

model History {
  id         Int      @id @default(autoincrement())
  userId     Int
  targetId   Int      
  targetType String   
  title      String
  coverUrl   String?
  routeUrl   String   
  visitedAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, targetType])
  @@index([userId, visitedAt])
}

model Favorite {
  id         Int      @id @default(autoincrement())
  userId     Int
  targetId   Int
  targetType String   
  title      String
  coverUrl   String?
  routeUrl   String
  createdAt  DateTime @default(now()) 

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, targetType])
  @@index([userId, createdAt])
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String   
  userId     Int
  targetId   Int
  targetType String   
  parentId   Int?     
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  parent     Comment?  @relation("ReplyTo", fields: [parentId], references: [id], onDelete: Cascade)
  children   Comment[] @relation("ReplyTo")

  @@index([targetId, targetType]) 
}

model Image {
  id        Int      @id @default(autoincrement())
  filename  String   
  url       String   @unique 
  createdAt DateTime @default(now())
}