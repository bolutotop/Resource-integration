generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --- 内容模型 ---

model Video {
  id          Int      @id @default(autoincrement())
  title       String
  // 注意：SQLite 中 String 默认就是 Text
  description String?
  videoUrl    String   @default("")
  coverUrl    String?
  type        String   @default("电影")
  rating      Float    @default(0.0)
  views       Int      @default(0)

  // --- 新增 & 优化字段 ---
  
  // 1. 新增来源站点字段，默认为 "Age"
  sourceSite  String   @default("Age")

  // 2. 移除了 @unique (改为由下方的复合索引控制)
  sourceId    String?

  status      String?        // 连载、完结、预告等
  year        String?  // 年份 (如 "2026")
  studio      String?  // 制作公司 (如 "J.C.STAFF")

  // --- 首页标记字段 ---
  isRecommended Boolean  @default(false) // 是否为“今日推荐”
  isRecent      Boolean  @default(false) // 是否为“最近更新” (用于人工置顶等场景)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 关联关系
  categories  Category[]
  tags        Tag[]
  likesCount  Int      @default(0)
  likes       Like[]

  // 3. 新增复合唯一索引：同一个站点下的 sourceId 才是唯一的
  @@unique([sourceSite, sourceId])
}

model Category {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

model Tag {
  id     Int     @id @default(autoincrement())
  name   String  @unique
  videos Video[]
}

// --- 用户与交互模型 ---

model User {
  id        Int      @id @default(autoincrement())
  name      String?
  email     String   @unique
  password  String
  avatar    String?
  role      String   @default("USER")
  createdAt DateTime @default(now())

  likes     Like[]
  history   History[]
  favorites Favorite[]
  comments  Comment[]
}

model Like {
  id        Int      @id @default(autoincrement())
  userId    Int
  videoId   Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
}

model History {
  id         Int      @id @default(autoincrement())
  userId     Int
  targetId   Int
  targetType String
  title      String
  coverUrl   String?
  routeUrl   String
  visitedAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, targetType])
  @@index([userId, visitedAt])
}

model Favorite {
  id         Int      @id @default(autoincrement())
  userId     Int
  targetId   Int
  targetType String
  title      String
  coverUrl   String?
  routeUrl   String
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetId, targetType])
  @@index([userId, createdAt])
}

model Comment {
  id         Int      @id @default(autoincrement())
  content    String
  userId     Int
  targetId   Int
  targetType String
  parentId   Int?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  parent     Comment?  @relation("ReplyTo", fields: [parentId], references: [id], onDelete: Cascade)
  children   Comment[] @relation("ReplyTo")

  @@index([targetId, targetType])
}

model Image {
  id        Int      @id @default(autoincrement())
  filename  String
  url       String   @unique
  createdAt DateTime @default(now())
}